<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ADMIN ‚Äî ƒêƒÇNG B·∫¢N TIN N√îNG V·ª§</title>
  <style>
    :root{--bg:#0b1220;--card:#0f172a;--txt:#e2e8f0;--muted:#94a3b8;--pri:#22c55e;--danger:#ef4444;--grid:#1f2937;--radius:14px;--shadow:0 10px 30px -14px rgba(0,0,0,.6)}
    *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--txt);font:16px/1.5 system-ui,Segoe UI,Roboto}
    .wrap{max-width:1100px;margin:24px auto;padding:0 12px}
    h1{font-size:28px;margin:8px 0 16px}
    .panel{background:var(--card);border:1px solid var(--grid);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin-bottom:16px}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--grid);background:#0b1220;color:var(--txt)}
    label{display:block;margin:8px 0 6px;color:var(--muted)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{display:inline-block;padding:10px 12px;border-radius:10px;border:1px solid var(--grid);text-decoration:none;color:var(--txt);background:#111827}
    .btn.primary{background:var(--pri);color:#04130b;border:none}
    .btn.danger{background:var(--danger);border:none}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--grid);padding:10px;font-size:14px}
    th{color:var(--muted);text-align:left}
    .muted{color:var(--muted)}
    .actions{display:flex;gap:8px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="wrap">
  <h1>üîê Admin ‚Äî ƒêƒÉng/S·ª≠a/X√≥a b·∫£n tin</h1>

  <!-- ƒêƒÉng nh·∫≠p -->
  <div id="auth" class="panel">
    <div class="row">
      <div><label>Email</label><input id="email" placeholder="admin@qtri.vn" /></div>
      <div><label>M·∫≠t kh·∫©u</label><input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" /></div>
    </div>
    <div style="margin-top:10px;display:flex;gap:8px">
      <button class="btn primary" id="btnLogin">ƒêƒÉng nh·∫≠p</button>
      <button class="btn" id="btnLogout" style="display:none">ƒêƒÉng xu·∫•t</button>
      <span id="authState" class="muted"></span>
    </div>
  </div>

  <!-- Form ƒëƒÉng b·∫£n tin -->
  <div id="formPanel" class="panel" style="display:none">
    <h3>T·∫°o / C·∫≠p nh·∫≠t b·∫£n tin</h3>
    <div class="row">
      <div><label>Ti√™u ƒë·ªÅ</label><input id="title" /></div>
      <div><label>Ng√†y ph√°t h√†nh</label><input id="date" type="date" /></div>
    </div>
    <div class="row">
      <div>
        <label>Chu k·ª≥</label>
        <select id="frequency">
          <option value="monthly" selected>H√†ng th√°ng</option>
          <option value="bimonthly">Hai th√°ng</option>
          <option value="daily">H√†ng ng√†y/kh·∫©n</option>
          <option value="alert">C·∫£nh b√°o</option>
        </select>
      </div>
      <div>
        <label>Tr·∫°ng th√°i</label>
        <select id="is_active">
          <option value="true" selected>Hi·ªÉn th·ªã c√¥ng khai</option>
          <option value="false">·∫®n</option>
        </select>
      </div>
    </div>

    <label>M√¥ t·∫£ ng·∫Øn</label>
    <textarea id="summary" rows="3" placeholder="T√≥m t·∫Øt n·ªôi dung n·ªïi b·∫≠t (t√πy ch·ªçn)"></textarea>

    <div class="row">
      <div><label>File b·∫£n tin (.docx ho·∫∑c .pdf)</label><input id="fileDoc" type="file" accept=".docx,.pdf" /></div>
      <div><label>File b·∫£ng s·ªë li·ªáu (.xlsx ho·∫∑c .pdf)</label><input id="fileData" type="file" accept=".xlsx,.pdf" /></div>
    </div>

    <div style="margin-top:10px;display:flex;gap:8px">
      <button class="btn primary" id="btnSave">L∆∞u (th√™m m·ªõi)</button>
      <button class="btn" id="btnReset">Reset</button>
      <span id="saveState" class="muted"></span>
    </div>
  </div>

  <!-- Danh s√°ch -->
  <div id="listPanel" class="panel" style="display:none">
    <h3>Danh s√°ch b·∫£n tin</h3>
    <table>
      <thead><tr><th>Ng√†y</th><th>Ti√™u ƒë·ªÅ</th><th>Chu k·ª≥</th><th>T·ªáp</th><th>Hi·ªÉn th·ªã</th><th></th></tr></thead>
      <tbody id="tbl"></tbody>
    </table>
  </div>
</div>

<script>
  // ===== Supabase (ƒë·ªçc/ghi) =====
  const SUPABASE_URL = "https://cegorn.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJwcHFxYm5hb3h5cXZ5Y3luZmFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MDQ4ODUsImV4cCI6MjA3NTM4MDg4NX0.GE0YNYgkVfsKT3iD9-jDm46PUIzkDtZFPP9Ec4iRcFA"; // <-- d√°n key anon v√†o ƒë√¢y
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ===== Helpers =====
  const fmtDate = d => new Date(d).toLocaleDateString('vi-VN');
  const yyyymm = (dateStr) => { const d = dateStr ? new Date(dateStr) : new Date(); return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}`; };
  const slug = s => (s||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');

  const els = {
    auth: document.getElementById('auth'),
    login: document.getElementById('btnLogin'),
    logout: document.getElementById('btnLogout'),
    email: document.getElementById('email'),
    password: document.getElementById('password'),
    authState: document.getElementById('authState'),
    formPanel: document.getElementById('formPanel'),
    listPanel: document.getElementById('listPanel'),
    title: document.getElementById('title'),
    date: document.getElementById('date'),
    frequency: document.getElementById('frequency'),
    is_active: document.getElementById('is_active'),
    summary: document.getElementById('summary'),
    fileDoc: document.getElementById('fileDoc'),
    fileData: document.getElementById('fileData'),
    btnSave: document.getElementById('btnSave'),
    btnReset: document.getElementById('btnReset'),
    saveState: document.getElementById('saveState'),
    tbl: document.getElementById('tbl'),
  };

  // ===== Auth flow =====
  sb.auth.onAuthStateChange((_event, session) => {
    const signedIn = !!session;
    els.authState.textContent = signedIn ? `ƒê√£ ƒëƒÉng nh·∫≠p: ${session.user.email}` : 'Ch∆∞a ƒëƒÉng nh·∫≠p';
    els.logout.style.display = signedIn ? 'inline-block' : 'none';
    els.formPanel.style.display = signedIn ? 'block' : 'none';
    els.listPanel.style.display = signedIn ? 'block' : 'none';
    if (signedIn) { loadList(); }
  });

  els.login.onclick = async () => {
    const { error } = await sb.auth.signInWithPassword({
      email: els.email.value.trim(),
      password: els.password.value.trim()
    });
    if (error) alert(error.message);
  };
  els.logout.onclick = async () => { await sb.auth.signOut(); };

  // ===== Upload helper =====
  async function uploadIfAny(file, folder, baseName) {
    if (!file) return null;
    const ext = file.name.split('.').pop().toLowerCase();
    const path = `${folder}/${baseName}.${ext}`;
    const { error } = await sb.storage.from('bulletins').upload(path, file, { upsert:true, cacheControl:'3600' });
    if (error) throw error;
    const { data: pub } = sb.storage.from('bulletins').getPublicUrl(path);
    return pub.publicUrl;
  }

  // ===== Create =====
  async function saveBulletin() {
    try {
      els.saveState.textContent = 'ƒêang l∆∞u‚Ä¶';
      const title = els.title.value.trim();
      const published_on = els.date.value || new Date().toISOString().slice(0,10);
      const frequency = els.frequency.value;
      const is_active = els.is_active.value === 'true';
      const summary = els.summary.value.trim();
      if (!title) return alert('Nh·∫≠p ti√™u ƒë·ªÅ');

      const folder = `${yyyymm(published_on)}/${slug(title)||'ban-tin'}`;
      const [doc_url, data_url] = await Promise.all([
        uploadIfAny(els.fileDoc.files[0], folder, 'main'),
        uploadIfAny(els.fileData.files[0], folder, 'data'),
      ]);

      const payload = { title, published_on, frequency, is_active, summary };
      if (doc_url)  payload.doc_url = doc_url;
      if (data_url) payload.data_url = data_url;

      const { error } = await sb.from('bulletins').insert(payload);
      if (error) throw error;

      els.saveState.textContent = 'ƒê√£ l∆∞u ‚úì';
      resetForm(); loadList();
    } catch (e) {
      console.error(e);
      els.saveState.textContent = 'L·ªói l∆∞u';
      alert(e.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
    } finally {
      setTimeout(()=> els.saveState.textContent='', 1500);
    }
  }

  // ===== Read/List =====
  async function loadList() {
    const { data, error } = await sb.from('bulletins').select('*').order('published_on',{ascending:false}).limit(200);
    if (error) { console.error(error); return; }
    els.tbl.innerHTML = '';
    for (const r of data) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${fmtDate(r.published_on)}</td>
        <td>${r.title}</td>
        <td>${r.frequency||''}</td>
        <td>${r.doc_url? `<a href="${r.doc_url}" target="_blank">b·∫£n tin</a>`:''}${r.data_url? ` ¬∑ <a href="${r.data_url}" target="_blank">s·ªë li·ªáu</a>`:''}</td>
        <td>${r.is_active ? 'Hi·ªÉn th·ªã' : '<span class="muted">·∫®n</span>'}</td>
        <td class="actions">
          <button class="btn" data-act="toggle" data-id="${r.id}" data-active="${r.is_active}">${r.is_active?'·∫®n':'Hi·ªán'}</button>
          <button class="btn danger" data-act="del" data-id="${r.id}">X√≥a</button>
        </td>
      `;
      els.tbl.appendChild(tr);
    }
  }

  // ===== Update / Delete (nhanh g·ªçn) =====
  document.getElementById('tbl').addEventListener('click', async (e)=>{
    const btn = e.target.closest('button'); if (!btn) return;
    const id = btn.getAttribute('data-id');
    const act = btn.getAttribute('data-act');
    if (act === 'del') {
      if (!confirm('X√≥a b·∫£n tin n√†y?')) return;
      const { error } = await sb.from('bulletins').delete().eq('id', id);
      if (error) return alert(error.message);
      loadList();
    } else if (act === 'toggle') {
      const active = btn.getAttribute('data-active') === 'true';
      const { error } = await sb.from('bulletins').update({ is_active: !active }).eq('id', id);
      if (error) return alert(error.message);
      loadList();
    }
  });

  function resetForm(){
    els.title.value=''; els.summary.value=''; els.fileDoc.value=''; els.fileData.value='';
    els.date.value = new Date().toISOString().slice(0,10);
    els.frequency.value='monthly'; els.is_active.value='true';
  }
  els.btnSave.onclick = saveBulletin;
  els.btnReset.onclick = resetForm;
  els.date.value = new Date().toISOString().slice(0,10);
</script>
</body>
</html>
